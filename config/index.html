<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Room Sketch (Doors Only)</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0a84ff">
<link rel="icon" href="./icons/icon-192.png" sizes="192x192">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<style>
  :root{--primary:#0a84ff;--border:#e5e5e5;--muted:#666}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff}
  header{position:sticky;top:0;z-index:2;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;padding:.5rem;border-bottom:1px solid var(--border);background:#fff}
  button{font-size:14px;padding:.5rem .7rem;border:1px solid var(--border);border-radius:.6rem;background:#fff}
  button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  #room{font-size:12px;color:#333;border:1px solid var(--border);border-radius:.5rem;padding:.2rem .5rem;background:#fff}
  #info{margin-left:auto;font-size:12px;color:#555}
  canvas{touch-action:none;display:block;width:100vw;height:calc(100vh - 60px);background:#fff}
  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111;color:#fff;padding:.6rem .9rem;border-radius:.7rem;font-size:13px;opacity:0;transition:opacity .2s}
  .toast.show{opacity:1}
</style>
</head>
<body>
<header>
  <span id="room">Loading...</span>
  <button id="drawBtn" class="primary">描画</button>
  <button id="exportBtn">CSV</button>
  <button id="resetBtn">リセット</button>
  <button id="installBtn" hidden>インストール</button>
  <span id="info"></span>
</header>
<canvas id="cv"></canvas>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(()=>{
'use strict';
let deferredPrompt=null;
const installBtn=document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;installBtn.hidden=false;});
installBtn.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.hidden=true;});
if('serviceWorker'in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));}

const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
const drawBtn=document.getElementById('drawBtn');
const exportBtn=document.getElementById('exportBtn');
const resetBtn=document.getElementById('resetBtn');
const roomEl=document.getElementById('room');
const info=document.getElementById('info');
const toast=document.getElementById('toast');
let toastTimer=null;

let ROOM=null, DOORS=[];
let GRID_SIZE=1, GRID_COLS=1, GRID_ROWS=1;
let s=1, ox=0, oy=0;
let drawing=false;
let raw=[], smooth=[];
const SMOOTH_ALPHA=0.25;

function setCanvasSize(){const dpr=window.devicePixelRatio||1;cv.width=Math.floor(cv.clientWidth*dpr);cv.height=Math.floor(cv.clientHeight*dpr);ctx.setTransform(dpr,0,0,dpr,0,0);layoutRoom();draw();}
window.addEventListener('resize', setCanvasSize);
function layoutRoom(){if(!ROOM)return;const pad=16,dw=cv.clientWidth-pad*2,dh=cv.clientHeight-pad*2;s=Math.min(dw/ROOM.width_m, dh/ROOM.height_m);const w=ROOM.width_m*s,h=ROOM.height_m*s;ox=(cv.clientWidth-w)/2;oy=(cv.clientHeight-h)/2;}
function worldToCanvas(wx,wy){let cx,cy;switch(ROOM.origin){case'SW':cx=ox+wx*s;cy=oy+(ROOM.height_m-wy)*s;break;case'NW':cx=ox+wx*s;cy=oy+wy*s;break;case'NE':cx=ox+(ROOM.width_m-wx)*s;cy=oy+wy*s;break;case'SE':cx=ox+(ROOM.width_m-wx)*s;cy=oy+(ROOM.height_m-wy)*s;break;default:cx=ox+wx*s;cy=oy+(ROOM.height_m-wy)*s;}return{x:cx,y:cy};}
function canvasToWorld(cx,cy){let wx,wy;switch(ROOM.origin){case'SW':wx=(cx-ox)/s;wy=ROOM.height_m-(cy-oy)/s;break;case'NW':wx=(cx-ox)/s;wy=(cy-oy)/s;break;case'NE':wx=ROOM.width_m-(cx-ox)/s;wy=(cy-oy)/s;break;case'SE':wx=ROOM.width_m-(cx-ox)/s;wy=ROOM.height_m-(cy-oy)/s;break;default:wx=(cx-ox)/s;wy=ROOM.height_m-(cy-oy)/s;}wx=Math.max(0,Math.min(ROOM.width_m,wx));wy=Math.max(0,Math.min(ROOM.height_m,wy));return{x:wx,y:wy};}
function toCanvasPoint(e){const r=cv.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top,t:performance.now()};}
function smoothPath(points,alpha){if(points.length===0)return[];const out=[{...points[0]}];for(let i=1;i<points.length;i++){const p=points[i],q=out[i-1];out.push({t:p.t,x:q.x+alpha*(p.x-q.x),y:q.y+alpha*(p.y-q.y)});}return out;}
function showToast(message,duration=2200){toast.textContent=message;toast.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>toast.classList.remove('show'),duration);}
function downloadCsv(csv){const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));const a=document.createElement('a');a.href=url;a.download='path_grid_segments.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),1000);}

function toSouthWest(wx,wy){
  switch(ROOM.origin){
    case'NW':return{x:wx,y:ROOM.height_m-wy};
    case'NE':return{x:ROOM.width_m-wx,y:ROOM.height_m-wy};
    case'SE':return{x:ROOM.width_m-wx,y:wy};
    default:return{x:wx,y:wy};
  }
}
function fromSouthWest(sx,sy){
  switch(ROOM.origin){
    case'NW':return{x:sx,y:ROOM.height_m-sy};
    case'NE':return{x:ROOM.width_m-sx,y:ROOM.height_m-sy};
    case'SE':return{x:ROOM.width_m-sx,y:sy};
    default:return{x:sx,y:sy};
  }
}
function gridIdFor(wx,wy){
  const sw=toSouthWest(wx,wy);
  const col=Math.min(GRID_COLS-1,Math.max(0,Math.floor(sw.x/GRID_SIZE)));
  const row=Math.min(GRID_ROWS-1,Math.max(0,Math.floor(sw.y/GRID_SIZE)));
  return row*GRID_COLS+col+1;
}

function draw(){
  ctx.clearRect(0,0,cv.clientWidth,cv.clientHeight);
  if(!ROOM) return;
  ctx.lineWidth=2;ctx.strokeStyle='#333';
  const W=ROOM.width_m*s,H=ROOM.height_m*s;ctx.strokeRect(ox,oy,W,H);
  if(GRID_SIZE>0){
    ctx.save();
    ctx.strokeStyle='rgba(0,0,0,0.2)';
    ctx.lineWidth=1;
    ctx.beginPath();
    for(let i=1;i<GRID_COLS;i++){
      const sx=i*GRID_SIZE;
      if(sx>=ROOM.width_m) break;
      const w0=fromSouthWest(sx,0);
      const w1=fromSouthWest(sx,ROOM.height_m);
      const a=worldToCanvas(w0.x,w0.y);
      const b=worldToCanvas(w1.x,w1.y);
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
    }
    for(let j=1;j<GRID_ROWS;j++){
      const sy=j*GRID_SIZE;
      if(sy>=ROOM.height_m) break;
      const w0=fromSouthWest(0,sy);
      const w1=fromSouthWest(ROOM.width_m,sy);
      const a=worldToCanvas(w0.x,w0.y);
      const b=worldToCanvas(w1.x,w1.y);
      ctx.moveTo(a.x,a.y);
      ctx.lineTo(b.x,b.y);
    }
    ctx.stroke();
    ctx.fillStyle='rgba(0,0,0,0.45)';
    const gridFontSize=Math.max(10, s*0.18);
    ctx.font=`${gridFontSize}px system-ui`;
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    for(let row=0;row<GRID_ROWS;row++){
      const baseY=row*GRID_SIZE;
      const cellHeight=Math.min(GRID_SIZE, ROOM.height_m-baseY);
      if(cellHeight<=0) continue;
      for(let col=0;col<GRID_COLS;col++){
        const baseX=col*GRID_SIZE;
        const cellWidth=Math.min(GRID_SIZE, ROOM.width_m-baseX);
        if(cellWidth<=0) continue;
        const centerX=baseX+cellWidth/2;
        const centerY=baseY+cellHeight/2;
        const world=fromSouthWest(centerX,centerY);
        const canvasPos=worldToCanvas(world.x,world.y);
        const gid=row*GRID_COLS+col+1;
        ctx.fillText(gid,canvasPos.x,canvasPos.y);
      }
    }
    ctx.restore();
  }
  ctx.lineCap='butt';ctx.strokeStyle='#2aa84a';
  for(const d of DOORS){const a=worldToCanvas(d.a.x,d.a.y), b=worldToCanvas(d.b.x,d.b.y);ctx.lineWidth=Math.max(2,(d.width_m||0.9)*s*0.5);ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();}
  if(smooth.length>0){ctx.lineJoin='round';ctx.lineCap='round';ctx.lineWidth=3;ctx.strokeStyle='#0a84ff';ctx.beginPath();const p0=worldToCanvas(smooth[0].x,smooth[0].y);ctx.moveTo(p0.x,p0.y);for(let i=1;i<smooth.length;i++){const p=worldToCanvas(smooth[i].x,smooth[i].y);ctx.lineTo(p.x,p.y);}ctx.stroke();}
  info.textContent=`W:${ROOM.width_m}m H:${ROOM.height_m}m 点:${smooth.length}`;
}

cv.addEventListener('pointerdown', e=>{if(!ROOM)return;cv.setPointerCapture(e.pointerId);drawing=true;raw.length=0;smooth.length=0;const p=toCanvasPoint(e),w=canvasToWorld(p.x,p.y);raw.push({x:w.x,y:w.y,t:p.t});smooth.push({x:w.x,y:w.y,t:p.t});draw();});
cv.addEventListener('pointermove', e=>{if(!drawing||!ROOM)return;const p=toCanvasPoint(e),w=canvasToWorld(p.x,p.y);raw.push({x:w.x,y:w.y,t:p.t});const last=smooth[smooth.length-1]||w;const sx=last.x+SMOOTH_ALPHA*(w.x-last.x);const sy=last.y+SMOOTH_ALPHA*(w.y-last.y);smooth.push({x:sx,y:sy,t:p.t});draw();});
cv.addEventListener('pointerup', e=>{drawing=false;});

drawBtn.addEventListener('click', ()=>{});
resetBtn.addEventListener('click', ()=>{raw.length=0;smooth.length=0;draw();});
exportBtn.addEventListener('click', async ()=>{
  if(smooth.length===0||!ROOM)return;
  const rows=[['start_ms','end_ms','grid_id']];
  const t0=smooth[0].t;
  let currentId=null,segmentStartT=null;
  for(let i=0;i<smooth.length;i++){
    const p=smooth[i];
    const gid=gridIdFor(p.x,p.y);
    if(currentId===null){
      currentId=gid;
      segmentStartT=p.t;
    }else if(gid!==currentId){
      const prevT=smooth[i-1].t;
      rows.push([(segmentStartT-t0).toFixed(1),(prevT-t0).toFixed(1),currentId]);
      currentId=gid;
      segmentStartT=p.t;
    }
  }
  if(currentId!==null){
    const lastT=smooth[smooth.length-1].t;
    rows.push([(segmentStartT-t0).toFixed(1),(lastT-t0).toFixed(1),currentId]);
  }
  const csv=rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const formData=new FormData();
  formData.append('file',blob,'path_grid_segments.csv');
  try{
    // Try local server first, fallback to download
    const uploadUrl = 'http://localhost:3000/upload';
    const res=await fetch(uploadUrl,{method:'POST',body:formData});
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    const result = await res.json();
    showToast(`CSVをローカルサーバへ送信しました (${result.filename})`);
  }catch(err){
    console.error('CSV upload failed',err);
    showToast('ローカルサーバーに接続できません。CSVをダウンロードしました');
    downloadCsv(csv);
  }
});

Promise.all([
  fetch('./config/room.json',{cache:'no-cache'}).then(r=>r.json()),
  fetch('./config/doors.json',{cache:'no-cache'}).then(r=>r.json())
]).then(([room,doors])=>{
  ROOM=room; DOORS=(doors&&doors.doors)||[];
  GRID_SIZE=ROOM.grid_m||1;
  GRID_COLS=Math.max(1,Math.ceil(ROOM.width_m/GRID_SIZE));
  GRID_ROWS=Math.max(1,Math.ceil(ROOM.height_m/GRID_SIZE));
  roomEl.textContent=`${ROOM.name||'Room'} (${ROOM.width_m}m×${ROOM.height_m}m)`;
  setCanvasSize();
}).catch(err=>{console.error(err);roomEl.textContent='設定読み込みエラー';});
})();</script>
</body></html>
